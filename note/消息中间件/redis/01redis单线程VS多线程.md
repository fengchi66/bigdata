## 问题

- redis是单线程还是多线程
- 为什么之前是单线程后来改为多线程
- redis为什么这么快

## Redis为什么选择单线程

这种问法其实并不严谨，为啥这么说呢?

Redis的版本很多3.x、4.x、6.x，版本不同架构也是不同的，不限定版本问是否单线程也不太严谨。 

- 版本3.x ，最早版本，也就是大家口口相传的redis是单线程，阳哥2016年讲解的redis就是3.X的版本
- 版本4.x，严格意义来说也不是单线程，而是负责处理客户端请求的线程是单线程，但是开始加了点多线程的东西(异步删除)
- 最新版本的6.0.x后，告别了大家印象中的单线程，用一种全新的多 线程来解决问题。

有几个里程碑式的重要版本

![img](https://gitee.com/joeyooa/data-images/raw/master/node/2021/A872C871-F1C9-4BB7-9C73-827352C170D3.png)

5.0版本是直接升级到6.0版本，对于这个激进的升级，Redis之父antirez表现得很有信心和兴奋， 所以第一时间发文来阐述6.0的一些重大功能`Redis 6.0.0 GA is out!`

### Redis是单线程究竟何意

Redis是单线程主要是指Redis的网络IO和键值对读写是由一个线程来完成的，Redis在处理客户端的请求时包括获取 (socket 读)、解析、执行、内容返回 (socket 写) 等都由一个顺序串行的主线程处理，这就是所谓的“单线程”。这也是Redis对外提供键值存储服务的主要流程。

![img](https://gitee.com/joeyooa/data-images/raw/master/node/2021/70CE9705-02F7-4E6B-AF2B-F4F6ED1AB852.png)

但Redis的其他功能，比如持久化、异步删除、集群数据同步等等，其实是由额外的线程执行的。

**Redis工作线程是单线程的，但是，整个Redis来说，是多线程的。** 

### Redis3.x单线程时代但性能依旧很快的主要原因

- 基于内存操作：Redis 的所有数据都存在内存中，因此所有的运算都是内存级别的，所以他的性能比较高；
- 数据结构简单：Redis 的数据结构是专门设计的，而这些简单的数据结构的查找和操作的时间大部分复杂度都是 O(1)，因此性能比较高；
- 多路复用和非阻塞 I/O：Redis使用 I/O多路复用功能来监听多个 socket连接客户端，这样就可以使用一个线程连接来处理多个请求，减少线程切换带来的开销，同时也避免了 I/O 阻塞操作
- 避免上下文切换：因为是单线程模型，因此就避免了不必要的上下文切换和多线程竞争，这就省去了多线程切换带来的时间和性能上的消耗，而且单线程不会导致死锁问题的发生

### Redis 4.0之前一直采用单线程的主要原因

![img](https://gitee.com/joeyooa/data-images/raw/master/node/2021/24069AD5-F700-4B7C-A82A-322041AB3382.png)

他的大体意思是说 Redis 是基于内存操作的，因此他的瓶颈可能是机器的内存或者网络带宽而并非 CPU，既然 CPU 不是瓶颈，那么自然就采用单线程的解决方案了，况且使用多线程比较麻烦。但是在 Redis 4.0 中开始支持多线程了，例如后台删除等功能。

**Redis 4.0之前一直采用单线程的主要原因**

- 使用单线程模型是 Redis 的开发和维护更简单，因为单线程模型方便开发和调试；

- 即使使用单线程模型也并发的处理多客户端的请求，主要使用的是**多路复用**和**非阻塞 IO**；

- **对于 Redis 系统来说，主要的性能瓶颈是内存或者网络带宽而并非 CPU**。

### 既然单线程这么好，为什么逐渐又加入了多线程特性？



