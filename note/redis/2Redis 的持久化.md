## AOF日志

### AOF日志实现

Redis 是先执行命令，把数据写入内存，然后才记录日志。AOF 里记录的是 Redis 收到的每一条命令，这些**命令是以文本形式保存的。**

![img](https://gitee.com/joeyooa/data-images/raw/master/node/2021/4d120bee623642e75fdf1c0700623a9f.jpg)

- Redis 在向 AOF 里面记录日志的时候，并**不会先去对这些命令进行语法检查**。所以，如果先记日志再执行命令的话，日志中就有可能记录了错误的命令，Redis 在使用日志恢复数据时，就可能会出错。
- 在命令执行后才记录日志，所以不会阻塞当前的写操作。

### AOF的潜在风险

- 如果刚执行完一个命令，还没有来得及记日志就宕机了，那么这个命令和相应的数据就有丢失的风险。
- AOF 虽然避免了对当前命令的阻塞，但可能会给下一个操作带来阻塞风险。这是因为，AOF 日志也是在主线程中执行的，如果在把日志文件写入磁盘时，磁盘写压力大，就会导致写盘很慢，进而导致后续的操作也无法执行了。
- **因为记录的是操作命令，而不是实际的数据，所以，用 AOF 方法进行故障恢复的时候，需要逐一把操作日志都执行一遍。如果操作日志非常多，Redis 就会恢复得很缓慢，影响到正常使用**

#### 写会策略

- Always，同步写回：每个写命令执行完，立马同步地将日志写回磁盘；
- Everysec，每秒写回：每个写命令执行完，只是先把日志写到 AOF 文件的内存缓冲区，每隔一秒把缓冲区中的内容写入磁盘；
- No，操作系统控制的写回：每个写命令执行完，只是先把日志写到 AOF 文件的内存缓冲区，由操作系统决定何时将缓冲区内容写回磁盘。

![img](https://gitee.com/joeyooa/data-images/raw/master/node/2021/72f547f18dbac788c7d11yy167d7ebf8.jpg)

### 重写机制

- AOF  文件是以追加的方式，逐一记录接收到的写命令的。当一个键值对被多条写命令反复修改时，AOF  文件会记录相应的多条命令。但是，在重写的时候，是根据这个键值对当前的最新状态，为它生成对应的写入命令。这样一来，一个键值对在重写日志中只用一条命令就行了，而且，在日志恢复时，只用执行这条命令，就可以直接完成这个键值对的写入了。
- ![img](https://gitee.com/joeyooa/data-images/raw/master/node/2021/6528c699fdcf40b404af57040bb8d208.jpg)
- 和 AOF 日志由主线程写回不同，**重写过程是由后台子进程 bgrewriteaof 来完成的，这也是为了避免阻塞主线程**，导致数据库性能下降。